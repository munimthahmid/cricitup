CREATE TABLE BATTING_RANK 
(
PLAYERID NUMBER,
RANK NUMBER
)
CREATE TABLE BOWLING_RANK 
(
PLAYERID NUMBER,
RANK NUMBER
)

INSERT INTO BATTING_RANK (PLAYERID)
SELECT PLAYERID
FROM PLAYER;

INSERT INTO BOWLING_RANK (PLAYERID)
SELECT PLAYERID
FROM PLAYER;



CREATE TABLE TEAM_STRENGTH 
(
TEAMID NUMBER,
BATTING NUMBER,
BOWLING NUMBER,
TOTAL NUMBER
);

CREATE TABLE DREAM11STATS (
BAT NUMBER,
BOWL NUMBER,
TOTAL NUMBER
);

CREATE TABLE DREAM11 (
PLAYERID NUMBER
);

CREATE OR REPLACE PROCEDURE ADD_TO_DREAM11(id IN NUMBER) IS 
counts NUMBER:=0;
BEGIN
SELECT COUNT(*) INTO counts
FROM DREAM11 
WHERE PLAYERID=id;
-- IF count =0 THEN  
IF counts =0 THEN 
INSERT INTO DREAM11(PLAYERID) VALUES(id);
END IF;
END;




CREATE OR REPLACE PROCEDURE TEAM_STRENGTH_UPDATE IS
  batting NUMBER := 0;
  bowling NUMBER := 0;
  total NUMBER := 0;
  counts NUMBER := 0;
BEGIN
  FOR T IN (SELECT TEAM_ID FROM TEAM) LOOP
    BEGIN
      SELECT SUM(NVL(RANK, 100)) INTO batting FROM batting_rank
      WHERE playerid IN (SELECT PLAYERID FROM PLAYER WHERE TEAM_ID = T.TEAM_ID);
			
      SELECT SUM(NVL(RANK, 100)) INTO bowling
      FROM (
        SELECT RANK
        FROM BOWLING_RANK
        WHERE playerid IN (SELECT PLAYERID FROM PLAYER WHERE TEAM_ID = T.TEAM_ID)
        ORDER BY NVL(RANK, 100) ASC
        FETCH FIRST 6 ROWS ONLY
      );

      SELECT COUNT(*) INTO counts FROM TEAM_STRENGTH WHERE TEAMID = T.TEAM_ID;

      IF counts = 1 THEN
        UPDATE TEAM_STRENGTH SET BATTING = batting, BOWLING = bowling WHERE TEAMID = T.TEAM_ID;
      ELSE
        INSERT INTO TEAM_STRENGTH (TEAMID, BATTING, BOWLING) VALUES (T.TEAM_ID, batting, bowling);
      END IF;

      DBMS_OUTPUT.PUT_LINE('Team ' || T.TEAM_ID || ': Batting = ' || batting || ', Bowling = ' || bowling);
      UPDATE TEAM_STRENGTH
			SET TOTAL=batting+bowling 
			WHERE TEAMID=T.TEAM_ID;
    EXCEPTION
      WHEN NO_DATA_FOUND THEN
        DBMS_OUTPUT.PUT_LINE('No data found for team ' || T.TEAM_ID);
      WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('An error occurred for team ' || T.TEAM_ID || ': ' || SQLERRM);
    END;
  END LOOP;
  
  COMMIT; -- Commit changes
END;



CREATE OR REPLACE PROCEDURE UPDATE_DREAM11_STATS  IS 
bats NUMBER:=0;
bowls NUMBER:=0;
totals NUMBER :=0;
counts NUMBER :=0;
BEGIN
SELECT SUM(BT.RANK) BAT INTO bats FROM DREAM11 D  JOIN BATTING_RANK BT 
ON D.PLAYERID=BT.PLAYERID
JOIN BOWLING_RANK BL ON 
D.PLAYERID=BL.PLAYERID;

SELECT SUM(RANK) INTO bowls FROM (
SELECT NVL(BL.RANK,150) AS RANK  FROM DREAM11 D  
JOIN BOWLING_RANK BL ON 
D.PLAYERID=BL.PLAYERID
ORDER BY NVL(BL.RANK,150) ASC
FETCH FIRST 6 ROWS ONLY
);
totals:=bats+bowls;
SELECT COUNT(*) INTO counts FROM DREAM11STATS ;
DBMS_OUTPUT.PUT_LINE(bats||bowls||totals||counts);
IF counts=1 THEN
	UPDATE DREAM11STATS 
	SET BAT=bats,
	BOWL=bowls,
	TOTAL=totals;
ELSE
INSERT INTO DREAM11STATS VALUES(bats,bowls,totals);
END IF;
END;